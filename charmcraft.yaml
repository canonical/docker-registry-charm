type: charm

bases:
  - build-on:
      - name: ubuntu
        channel: "22.04"
        architectures: ["amd64"]
    run-on:
      - name: ubuntu
        channel: "22.04"
        architectures: ["amd64", "arm64", "s390x"]
      - name: ubuntu
        channel: "24.04"
        architectures: ["amd64", "arm64", "s390x"]
parts:
  charm:
    source: src
    plugin: reactive
    override-build: |
      ./prepare_layers.sh
      craftctl default
      git -C $CRAFT_PROJECT_DIR rev-parse --short HEAD > version
    reactive-charm-build-arguments:
    - --layer-index
    - 'http://localhost'  # Fake layer index to avoid network calls
    - --debug
    - --force
    build-packages:
    - wget
    - python3-dev
    build-snaps:
    - charm/3.x/stable
    - yq
    build-environment:
    - CHARM_LAYERS_DIR: $CRAFT_STAGE/tmp/layers/
    - CHARM_INTERFACES_DIR: $CRAFT_STAGE/tmp/interfaces/
    - LAYER_INDEX: https://raw.githubusercontent.com/charmed-kubernetes/layer-index/main/
    - RELEASE_BRANCH: main
